(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))r(e);new MutationObserver(e=>{for(const s of e)if(s.type==="childList")for(const n of s.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&r(n)}).observe(document,{childList:!0,subtree:!0});function i(e){const s={};return e.integrity&&(s.integrity=e.integrity),e.referrerPolicy&&(s.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?s.credentials="include":e.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function r(e){if(e.ep)return;e.ep=!0;const s=i(e);fetch(e.href,s)}})();class z{constructor(t,i,r){this.spriteMap=new Map,this.loaded=!1,this.image=new Image,this.image.src=i,Promise.all([fetch(t).then(e=>e.json()),new Promise(e=>{this.image.onload=()=>e()})]).then(([e])=>{if(e.meta&&e.meta.slices)for(const s of e.meta.slices){const n=s.name,l=s.keys[0].bounds;this.spriteMap.set(n,l)}this.loaded=!0,r&&r()})}isLoaded(){return this.loaded}drawSprite(t,i,r,e,s,n){const l=this.spriteMap.get(i);if(!l||!this.loaded)return;const d=Math.round(l.x),p=Math.round(l.y),f=Math.round(l.w),c=Math.round(l.h),a=Math.round(r),g=Math.round(e),S=Math.round(s),T=Math.round(n);t.drawImage(this.image,d,p,f,c,a,g,S,T)}}function m(u){switch(u){case"up":return[-1,0];case"down":return[1,0];case"left":return[0,-1];case"right":return[0,1]}}function v(u){switch(u){case"up":return"down";case"down":return"up";case"left":return"right";case"right":return"left"}}function C(u){switch(u){case"up":return"right";case"right":return"down";case"down":return"left";case"left":return"up"}}const b={up:"BeltN",down:"BeltS",left:"BeltW",right:"BeltE"};class o{constructor(t="up"){this.product=null,this.plannedProduct=null,this.slideProgress=1,this.slideSpeed=.02,this.prevProduct=null,this.direction=t}plan(t,i,r){if(this.product!=null||this.slideProgress<1){this.plannedProduct=null;return}const[e,s]=m(v(this.direction)),n=i+e,l=r+s,d=t.getTile(n,l);if(!d){this.plannedProduct=null;return}this.plannedProduct=d.pullProduct(this.direction,t,n,l)}apply(t,i,r){this.slideProgress<1?(this.slideProgress+=this.slideSpeed,this.slideProgress>1&&(this.slideProgress=1),this.slideProgress>=1&&this.prevProduct&&(this.product=this.prevProduct,this.prevProduct=null)):this.product==null&&this.plannedProduct&&(this.prevProduct=this.plannedProduct,this.slideProgress=0,this.plannedProduct=null)}renderTile(t,i,r,e){const s=i.tileSize;this.prevProduct&&(t.save(),t.strokeStyle="#ffd600",t.lineWidth=4,t.globalAlpha=.6,t.strokeRect(e*s+2,r*s+2,s-4,s-4),t.restore());const n=b[this.direction];i.aseprite.drawSprite(t,n,e*s,r*s,s,s)}renderProduct(t,i,r,e){let s=this.product,n=1;if(this.slideProgress<1&&this.prevProduct&&(s=this.prevProduct,n=this.slideProgress),s){i.tileSize;const[l,d]=m(v(this.direction)),p=e+d,f=r+l;n+=.5;const c=p*(1-n)+e*n,a=f*(1-n)+r*n;s.renderProduct(t,i,c,a)}}pullProduct(t,i,r,e){if(t===this.direction&&this.product){const s=this.product;return this.product=null,s}return null}}class h{plan(t,i,r){}apply(t,i,r){}renderTile(t,i,r,e){}renderProduct(t,i,r,e){}pullProduct(t,i,r,e){return null}}const x={up:"LeftN",down:"LeftS",left:"LeftW",right:"LeftE"};class P{constructor(t="up"){this.product=null,this.plannedProduct=null,this.slideProgress=1,this.slideSpeed=.02,this.prevProduct=null,this.outputDir=t}inputDir(){return C(this.outputDir)}plan(t,i,r){if(this.product==null&&this.slideProgress>=1){const[e,s]=m(C(this.outputDir)),n=i-e,l=r-s,d=t.getTile(n,l);d?this.plannedProduct=d.pullProduct(C(this.outputDir),t,n,l):this.plannedProduct=null}else this.plannedProduct=null}apply(t,i,r){this.slideProgress<1?(this.slideProgress+=this.slideSpeed,this.slideProgress>1&&(this.slideProgress=1),this.slideProgress===1&&this.prevProduct&&(this.product=this.prevProduct,this.prevProduct=null)):this.product==null&&this.plannedProduct&&(this.prevProduct=this.plannedProduct,this.slideProgress=0,this.plannedProduct=null)}renderTile(t,i,r,e){const s=i.tileSize,n=x[this.outputDir];i.aseprite.drawSprite(t,n,e*s,r*s,s,s)}renderProduct(t,i,r,e){let s=this.product,n=1;if(this.slideProgress<1&&this.prevProduct&&(s=this.prevProduct,n=this.slideProgress),s){i.tileSize;let[l,d]=m(C(this.outputDir)),[p,f]=m(this.outputDir),c,a;if(l*=.5,d*=.5,p*=.5,f*=.5,n<.5){const g=n/.5;c=(r-l)*(1-g)+r*g,a=(e-d)*(1-g)+e*g}else{const g=(n-.5)/.5;c=r*(1-g)+(r+p)*g,a=e*(1-g)+(e+f)*g}s.renderProduct(t,i,a,c)}}pullProduct(t,i,r,e){if(t===this.outputDir&&this.product){const s=this.product;return this.product=null,s}return null}}class w{constructor(t){this.pixels=t||w.defaultPixels()}static defaultPixels(){const t=["#ff9800","#f44336","#4caf50","#2196f3","#9c27b0","#ffeb3b","#00bcd4","#e91e63"];return Array.from({length:8},(i,r)=>Array.from({length:8},(e,s)=>t[(s+r)%t.length]))}renderProduct(t,i,r,e){const s=i.tileSize,n=s/2,l=n/8,d=(s-n)/2;for(let c=0;c<8;c++)for(let a=0;a<8;a++)t.fillStyle=this.pixels[c][a],t.fillRect(r*s+d+a*l,e*s+d+c*l,l,l);const p=r*s+s/2,f=e*s+s/2;t.save(),t.strokeStyle="#ff00ff",t.lineWidth=2,t.beginPath(),t.moveTo(p-80,f),t.lineTo(p+80,f),t.moveTo(p,f-80),t.lineTo(p,f+80),t.stroke(),t.restore()}}class E{constructor(t,i,r){this.highlightCell=null,this.gridSize=t,this.canvasSize=i,this.tileSize=i/t,this.aseprite=r,this.grid=[[new P("down"),new o("left"),new o("left"),new o("left"),new o("left"),new o("left"),new P("left")],[new o("down"),new o("right"),new h,new o("left"),new h,new h,new o("up")],[new o("down"),new h,new o("down"),new h,new h,new h,new o("up")],[new o("down"),new h,new h,new P("down"),new o("left"),new o("left"),new o("up")],[new o("down"),new h,new o("left"),new o("left"),new o("left"),new o("left"),new o("up")],[new o("down"),new h,new h,new h,new h,new h,new o("up")],[new P("right"),new o("right"),new o("up"),new o("right"),new o("right"),new o("right"),new P("up")]],this.grid[3][4].product=new w,this.grid[4][5].product=new w,this.grid[1][0].product=new w,this.grid[0][1].product=new w;const e=this.grid[6][3];e instanceof o&&(e.product=new w)}getTile(t,i){if(!(t<0||t>=this.grid.length)&&!(i<0||i>=this.grid[0].length))return this.grid[t][i]}setHighlightCell(t){this.highlightCell=t}update(){for(let t=0;t<this.gridSize;t++)for(let i=0;i<this.gridSize;i++)this.grid[t][i].plan(this,t,i);for(let t=0;t<this.gridSize;t++)for(let i=0;i<this.gridSize;i++)this.grid[t][i].apply(this,t,i)}renderTiles(t){const i=t.getTileCtx();for(let r=0;r<this.gridSize;r++)for(let e=0;e<this.gridSize;e++)typeof this.grid[r][e].renderTile=="function"?this.grid[r][e].renderTile(i,this,r,e):this.grid[r][e].render(i,this,r,e);this.highlightCell&&(i.save(),i.fillStyle="rgba(255,255,0,0.3)",i.fillRect(this.highlightCell.x*this.tileSize,this.highlightCell.y*this.tileSize,this.tileSize,this.tileSize),i.restore())}renderProducts(t){const i=t.getProductCtx();for(let r=0;r<this.gridSize;r++)for(let e=0;e<this.gridSize;e++){const s=this.grid[r][e];typeof s.renderProduct=="function"&&s.renderProduct(i,this,r,e)}}}class R{constructor(t,i,r){this.tileCanvas=t,this.tileCtx=this.tileCanvas.getContext("2d"),this.productCanvas=i,this.productCtx=this.productCanvas.getContext("2d"),this.factory=r,this.setupCanvas(),this.aseprite=r.aseprite,this.gameLoop()}gameLoop(){requestAnimationFrame(()=>this.gameLoop()),this.aseprite.isLoaded()&&(this.factory.update(),this.tileCtx.clearRect(0,0,this.tileCanvas.width,this.tileCanvas.height),this.productCtx.clearRect(0,0,this.productCanvas.width,this.productCanvas.height),this.factory.renderTiles(this),this.factory.renderProducts(this))}getTileCtx(){return this.tileCtx}getProductCtx(){return this.productCtx}getPixelSize(){return 112}setupCanvas(){this.tileCtx.imageSmoothingEnabled=!1,this.productCtx.imageSmoothingEnabled=!1,this.tileCanvas.addEventListener("mousemove",t=>{}),this.tileCanvas.addEventListener("mouseleave",()=>{})}}const y=document.getElementById("gameCanvas"),L=document.getElementById("productCanvas"),D=7,I=y.width,M=new E(D,I,new z("assets/sprites.json","assets/sprites.png"));new R(y,L,M);
